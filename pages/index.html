<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Let's Travel!</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.20/c3.css"
      integrity="sha512-GQSxWe9Cj4o4EduO7zO9HjULmD4olIjiQqZ7VJuwBxZlkWaUFGCxRkn39jYnD2xZBtEilm0m4WBG7YEmQuMs5Q=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  </head>
  <body>
    <section class="section">
      <div class="container">
        <div class="wrapper cover-wrapper">
          <div class="row">
            <div class="col-md-6 col-12">
              <div class="d-flex flex-column">
                <img
                  src="https://raw.githubusercontent.com/hexschool/2022-web-layout-training/refs/heads/main/js_week5/main_img.png"
                  class="mb-5"
                />
                <img
                  src="https://raw.githubusercontent.com/hexschool/2022-web-layout-training/refs/heads/main/js_week5/logo.png"
                  class="d-none d-sm-block"
                />
              </div>
            </div>
            <div class="col-md-6 col-12">
              <h1 class="form-title">
                <i class="bi bi-plus-circle"></i>新增旅遊套票
              </h1>
              <form action="" id="ticketAddForm">
                <div class="d-flex mb-4">
                  <label for="ticketName" class="form-label">套票名稱</label>
                  <div class="d-flex flex-column w-100">
                    <input
                      type="text"
                      class="form-control form-custom"
                      id="ticketName"
                      placeholder="請填寫套票名稱"
                    />
                  </div>
                </div>
                <div class="d-flex mb-4">
                  <label for="ticketImgUrl" class="form-label">圖片網址</label>
                  <div class="d-flex flex-column w-100">
                    <input
                      type="text"
                      class="form-control form-custom"
                      id="ticketImgUrl"
                      placeholder="請填寫圖片網址"
                    />
                  </div>
                </div>
                <div class="d-flex mb-4">
                  <label for="ticketRegion" class="form-label">景點地區</label>
                  <div class="d-flex flex-column w-100">
                    <select
                      class="form-control form-custom form-select form-secondary"
                      id="ticketRegion"
                    >
                      <option value="" selected>請選擇景點地區</option>
                      <option value="台北">台北</option>
                      <option value="台中">台中</option>
                      <option value="高雄">高雄</option>
                    </select>
                  </div>
                </div>
                <div class="d-flex mb-4">
                  <label for="ticketPrice" class="form-label">套票金額</label>
                  <div class="d-flex flex-column w-100">
                    <input
                      type="number"
                      class="form-control form-custom"
                      id="ticketPrice"
                      placeholder="請填寫套票金額"
                    />
                  </div>
                </div>
                <div class="d-flex mb-4">
                  <label for="ticketSetNum" class="form-label">套票組數</label>
                  <div class="d-flex flex-column w-100">
                    <input
                      type="number"
                      class="form-control form-custom"
                      id="ticketSetNum"
                      placeholder="請填寫套票組數"
                    />
                  </div>
                </div>
                <div class="d-flex mb-4">
                  <label for="ticketRank" class="form-label">套票星級</label>
                  <div class="d-flex flex-column w-100">
                    <input
                      type="number"
                      class="form-control form-custom"
                      id="ticketRank"
                      placeholder="請填寫套票星級"
                    />
                  </div>
                </div>
                <div class="d-flex mb-6">
                  <label for="ticketDescription" class="form-label"
                    >套票描述</label
                  >
                  <div class="d-flex flex-column w-100">
                    <textarea
                      class="form-control form-custom"
                      placeholder="請填寫套票描述（限 100 字）"
                      id="ticketDescription"
                      style="height: 111px;"
                    ></textarea>
                  </div>
                </div>
                <div class="d-flex">
                  <button
                    type="button"
                    class="btn btn-primary ms-auto"
                    id="addTicket"
                  >
                    新增套票
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>
    <main class="main">
      <div class="container">
        <div class="wrapper d-flex align-items-flex-start">
          <div class="d-flex align-items-center">
            <select
              class="form-control form-select form-secondary filter-select"
              id="filterRegion"
            >
              <option value="" selected>請選擇景點地區</option>
              <option value="台北">台北</option>
              <option value="台中">台中</option>
              <option value="高雄">高雄</option>
              <option value="花蓮">花蓮</option>
            </select>
            <p id="filterNums" class="form-text text-secondary">
              本次搜尋共 6 筆資料
            </p>
          </div>
          <div id="chart" class="ms-auto"></div>
        </div>
        <ul class="row row-gap-8 mt-12" id="ticketDisplay">
          <!-- <li class="col-12 col-sm-6 col-lg-4">
            <div class="roundImgCard">
              <img
                src="https://github.com/hexschool/2022-web-layout-training/blob/main/js_week5/travel_1.png?raw=true"
                alt=""
              />
              <p class="card-badge badge-primary-100">台北</p>
              <div class="card-body">
                <p class="card-badge-sm badge-primary">8.6</p>
                <h3 class="card-title">綠島自由行套裝行程</h3>
                <p class="card-content">
                  嚴選超高CP值綠島自由行套裝行程，多種綠島套裝組合，提供台東綠島來回船票、綠島環島機車、綠島民宿住宿，行程加贈『綠島浮潛體驗』以及『綠島生態導覽』，讓你用輕鬆的綠島套裝自由行，也能深度認識綠島在地文化。
                </p>
                <div class="card-info">
                  <p>
                    <i class="bi bi-exclamation-circle-fill"></i>剩下最後 8 組
                  </p>
                  <p class="infoPrice">
                    TWD<span class="highlight">$1,280</span>
                  </p>
                </div>
              </div>
            </div>
          </li> -->
          <!-- <li class="col-12 col-sm-6 col-lg-4">
            <div class="roundImgCard">
              <img
                src="https://github.com/hexschool/2022-web-layout-training/blob/main/js_week5/travel_1.png?raw=true"
                alt=""
              />
              <p class="card-badge badge-primary-100">台北</p>
              <div class="card-body">
                <p class="card-badge-sm badge-primary">8.6</p>
                <h3 class="card-title">綠島自由行套裝行程</h3>
                <p class="card-content">
                  嚴選超高CP值綠島自由行套裝行程，多種綠島套裝組合，提供台東綠島來回船票、綠島環島機車、
                </p>
                <div class="card-info">
                  <p>
                    <i class="bi bi-exclamation-circle-fill"></i>剩下最後 8 組
                  </p>
                  <p class="infoPrice">
                    TWD<span class="highlight">$1,280</span>
                  </p>
                </div>
              </div>
            </div>
          </li> -->
          <!-- <li class="col-12 col-sm-6 col-lg-4">
            <div class="roundImgCard">
              <img
                src="https://github.com/hexschool/2022-web-layout-training/blob/main/js_week5/travel_1.png?raw=true"
                alt=""
              />
              <p class="card-badge badge-primary-100">台北</p>
              <div class="card-body">
                <p class="card-badge-sm badge-primary">8.6</p>
                <h3 class="card-title">綠島自由行套裝行程</h3>
                <p class="card-content">
                  嚴選超高CP值綠島自由行套裝行程，多種綠島套裝組合，提供台東綠島來回船票、綠島環島機車、綠島民宿住宿，行程加贈『綠島浮潛體驗』以及『綠島生態導覽』，讓你用輕鬆的綠島套裝自由行，也能深度認識綠島在地文化。
                </p>
                <div class="card-info">
                  <p>
                    <i class="bi bi-exclamation-circle-fill"></i>剩下最後 8 組
                  </p>
                  <p class="infoPrice">
                    TWD<span class="highlight">$1,280</span>
                  </p>
                </div>
              </div>
            </div>
          </li> -->
        </ul>
        <div class="cantFind-area mt-12">
          <!-- <p class="contentMsg">查無此關鍵字資料</p> -->
          <img
            src="https://github.com/hexschool/2022-web-layout-training/blob/main/js_week5/no_found.png?raw=true"
            alt=""
          />
        </div>
      </div>
    </main>
    <script type="module" src="../main.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.18/c3.js"></script>
    <script type="module">

      import axios from 'axios';
      import validate from "validate.js";

      let constraints={
        name:{
          presence:{
            allowEmpty: false,
            message:'^套票名稱為必填!'
          },
        },
        imgUrl: {
          presence:{
            allowEmpty: false,
            message:'^圖片網址為必填!'
          },
          url:{
            schemes: ["http", "https"],
            message: "^圖片網址必須是正確的網址!",
          },
        },
        area:{
          presence:{
            allowEmpty: false,
            message:'^景點地區為必填欄位!'
          }
        },
        description:{
          length: {
            minimum: 1,
            maximum:100,
            message:'^套票描述必填，且不能超過 100 字'
            }
        },
        group:{
          numericality:{
            greaterThan: 0,
            message:'^套票組數必須為大於等於0'
          },
          type:{
            type:'integer',
            message:'^套票組數須為整數'
          }
        },
        price:{
          numericality:{
            greaterThan: 0,
            message:'^套票金額必須大於0！'
          },
          type:{
            type:'integer',
            message:'^套票金額須為整數'
          }
        },
        rate:{
          numericality:{
            greaterThanOrEqualTo: 1,
            lessThanOrEqualTo:10,
            message:'^套票星級必須在 1 至 10 之間!'
          }
        }
      }

      const ticketForm = document.querySelector('#ticketAddForm');
      const ticketName = document.querySelector('#ticketName');
      const ticketImgUrl = document.querySelector('#ticketImgUrl');
      const ticketPrice = document.querySelector('#ticketPrice');
      const ticketRegion = document.querySelector('#ticketRegion');
      const ticketSetNum = document.querySelector('#ticketSetNum');
      const ticketRank = document.querySelector('#ticketRank');
      const ticketDescription = document.querySelector('#ticketDescription');
      const addTicket = document.querySelector('#addTicket');

      const filterRegion = document.querySelector('#filterRegion');
      const filterNums = document.querySelector('#filterNums');
      const ticketDisplay = document.querySelector('#ticketDisplay');
      const ticketLink = document.querySelectorAll('.ticket-link');
      const cantFindArea = document.querySelector('.cantFind-area');
      const chartDisplay=document.querySelector('#chart');

      const dataUrl1='https://raw.githubusercontent.com/hexschool/js-training/main/travelAPI-lv1.json';
      const dataUrl2='https://raw.githubusercontent.com/hexschool/js-training/main/travelApi.json';
      let ticketsData=new Array;
      const chartPatternColors=['#26C0C7','#5151D3','#E68618'];

      const init=()=>{
        loadData();
      };

      // getData
      const loadData=()=>{
        axios.get(dataUrl2).then((response)=>{
          ticketsData=response.data.data;
          renderTicket(ticketsData);
          renderChart(ticketsData,chartPatternColors);
        }).catch((error)=>{
          renderTicket(ticketsData);
          window.alert(`${error.response.data}`)
        })
      }
      // format ChartData
      const formatData=(ticketData)=>{
        let chartData=new Object;
        ticketData.forEach(ticket=>{
          if(chartData[ticket.area]===undefined){
            chartData[ticket.area]=1;
          }else{
            chartData[ticket.area]++;
          }
        })
        return Object.entries(chartData)
      }

      //card內容
      const ticketCard = (ticketData) => {
            // const ticketDisplay = document.querySelector('#ticketDisplay');
            ticketDisplay.innerHTML = '';
            ticketData.forEach(item => {
                const ticketList = document.createElement('li');
                ticketList.className = 'col-12 col-sm-6 col-lg-4';

                const ticketCard = document.createElement('div');
                ticketCard.className = 'roundImgCard';
                const ticketLink = document.createElement('a');
                ticketLink.href = '#';
                ticketLink.className = 'ticket-link';

                const cardImg = document.createElement('img');
                cardImg.src = item.imgUrl;
                const imgBadge = document.createElement('p');
                imgBadge.className = 'card-badge badge-primary-100';
                imgBadge.textContent = item.area;

                const cardBody = document.createElement('div');
                cardBody.className = 'card-body';
                const cardBodyBadge = document.createElement('p');
                cardBodyBadge.className = 'card-badge-sm badge-primary';
                cardBodyBadge.textContent = item.rate;
                const cardTitle = document.createElement('h3');
                cardTitle.className = 'card-title';
                cardTitle.textContent = item.name;
                const cardContent = document.createElement('p');
                cardContent.textContent = item.description;

                const cardInfo = document.createElement('div');
                cardInfo.className = 'card-info';
                const groupInfo = document.createElement('p');
                const groupNoneHtml = `<i class="bi bi-exclamation-circle-fill"></i>限時搶購`;
                const groupLeftHtml = `<i class="bi bi-exclamation-circle-fill"></i>剩下最後 ${item.group} 組`;
                groupInfo.innerHTML = (item.group == 0) ? groupNoneHtml : groupLeftHtml;
                const ticketInfo = document.createElement('p');
                ticketInfo.className = 'infoPrice';
                ticketInfo.innerHTML = `TWD<span class="highlight">$${item.price}</span>`;

                cardInfo.appendChild(groupInfo);
                cardInfo.appendChild(ticketInfo);

                cardBody.appendChild(cardBodyBadge);
                cardBody.appendChild(cardTitle);
                cardBody.appendChild(cardContent);
                cardBody.appendChild(cardInfo);

                ticketLink.appendChild(cardImg);
                ticketCard.appendChild(ticketLink);
                ticketCard.appendChild(imgBadge);
                ticketCard.appendChild(cardBody);

                ticketList.appendChild(ticketCard);
                // console.log(ticketList);
                ticketDisplay.appendChild(ticketList);
              });
      };

      //渲染
      const renderTicket = (ticketData) => {
            let dataNum = ticketData.length;
            if (dataNum !== 0) {
              filterNums.textContent = `本次搜尋共 ${dataNum} 筆資料`;
              cantFindArea.style.display = 'none';
              chartDisplay.style.display='block';
              ticketDisplay.style.display = 'flex';
              ticketCard(ticketData);
            } else {
              filterNums.textContent = `查無此關鍵字資料`;
              ticketDisplay.style.display = 'none';
              chartDisplay.style.display='none';
              cantFindArea.style.display = 'block';
              }
      };

      const renderChart=(ticketData,patternColor)=>{
      // chart generate
        const ticketChart=c3.generate({
        bindTo:'#chart',
        data:{
          type:'donut',
          columns: formatData(ticketData)
        },
        color: {
            pattern: patternColor
        },
        donut: {
          title: "套票地區比重",
          label:{
            show:false
          },
          width:10
        },
        size:{
          height:180,
          width:160
        },
        padding:{
          top:0,
          bottom:0
        }
      });
      }

      //取得patternColor
      const areaPatternColors=(filterIndex)=>chartPatternColors.map((color,index)=>(index===filterIndex)? `${color}`:'#c8c8c84d');

      const filterColorIndex=(filterArea)=>{
        let chartArea=formatData(ticketsData).map(chartData=>chartData[0]);
        return chartArea.indexOf(`${filterArea}`);
      }

      //監聽
      addTicket.addEventListener('click', () => {
        let newTicket = new Object;
        let errorMsg = '';
        let lastIndex=ticketsData.length-1;
        newTicket.id = Number(ticketsData[lastIndex].id)+1;
        newTicket.name = ticketName.value.trim();
        newTicket.imgUrl = ticketImgUrl.value.trim();
        newTicket.area = ticketRegion.value.trim();
        newTicket.description = ticketDescription.value.trim();
        newTicket.group = Number(ticketSetNum.value.trim());
        newTicket.price = Number(ticketPrice.value.trim());
        newTicket.rate = Number(ticketRank.value.trim());
        removeMessage();
        let validateResults=validate(newTicket, constraints);
        if(validateResults){
          // console.log(validateResults);
          let messageTargets=messageItem(validateResults);
          messageTargets.forEach(target=>renderMessage(target,validateResults));
          return
        }else{
          window.alert('新增成功');
        }

        ticketsData.push(newTicket);
        ticketForm.reset();
        filterRegion.value = '';
        renderTicket(ticketsData);
        renderChart(ticketsData,chartPatternColors);
      });

      filterRegion.addEventListener('change', () => {
        let filterData = new Array;
        let selectedRegion=filterRegion.value;
        if(!selectedRegion){
          renderTicket(ticketsData);
          renderChart(ticketsData,chartPatternColors);
        }else{
          filterData=ticketsData.filter(ticketData=>ticketData.area===selectedRegion);
          let filterPatternColors=areaPatternColors(filterColorIndex(selectedRegion));
          renderTicket(filterData);
          renderChart(ticketsData,filterPatternColors);
        }
      });

      ticketDisplay.addEventListener('click',e=>{
        e.preventDefault();
      });

      //validate message
      const renderMessage=(targetItem,messages)=>{
        let targetParent=targetItem[0].parentNode;
        let messageElement=targetParent.querySelector('.form-invalid');
        let messageName=targetItem[1];
        if(!messageElement){
          let messageText=document.createElement('span');
          messageText.classList.add('form-invalid');
          messageText.textContent=`${messages[messageName][0]}`;
          targetParent.appendChild(messageText);
        }else{
          messageElement.textContent=`${messages[messageName][0]}`;
        }
      }

      const messageItem=(messages)=>{
        let messageItems= Object.keys(messages);

        return messageItems.map(messageItem=>
          (messageItem==='name')? [ticketName,messageItem]:
          (messageItem==='imgUrl')? [ticketImgUrl,messageItem]:
          (messageItem==='area')? [ticketRegion,messageItem]:
          (messageItem==='description')? [ticketDescription,messageItem]:
          (messageItem==='group')? [ticketSetNum,messageItem]:
          (messageItem==='price')? [ticketPrice,messageItem]:[ticketRank,messageItem]
        )
      }

      const removeMessage=()=>{
        const errorMessages=document.querySelectorAll('.form-invalid');
        errorMessages.forEach(errorMessage=>errorMessage.remove());
      }


      init();
    </script>
  </body>
</html>
